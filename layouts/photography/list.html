{{- define "main" }}
<div class="photo-gallery-grid">
    {{- range .Pages }}
    {{- $img := .Resources.GetMatch "*.{jpg,jpeg,png,webp}" }}
    {{- if $img }}
    <a href="{{ $img.RelPermalink }}" class="photo-thumb-link no-underline"
       data-slug="{{ .File.ContentBaseName }}"
       data-alt="{{ with .Params.alt }}{{ . }}{{ else }}{{ .Title }}{{ end }}"
       data-title="{{ .Title }}"
       data-description="{{ .Params.description }}">
        {{- $thumb := $img.Fill "300x300 q85" }}
        <img src="{{ $thumb.RelPermalink }}" alt="{{ with .Params.alt }}{{ . }}{{ else }}{{ .Title }}{{ end }}" class="photo-thumb" loading="lazy" />
    </a>
    {{- end }}
    {{- end }}
</div>
<div id="scroll-sentinel"></div>
{{- if gt (len .Pages) 0 }}
<div id="lightbox" class="lightbox-overlay" aria-hidden="true">
    <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    <div class="lightbox-content">
        <div class="lightbox-header">
            <a href="/" class="lightbox-site-title">Matt Walker</a>
            <div class="lightbox-subtitle">Photography</div>
            <hr class="lightbox-header-rule" />
        </div>
        <div class="lightbox-img-and-meta">
            <div class="lightbox-img-wrap">
                <img class="lightbox-img" src="" alt="" />
                <div class="lightbox-nav lightbox-nav-prev" aria-label="Previous photo">&#8249;</div>
                <div class="lightbox-nav lightbox-nav-next" aria-label="Next photo">&#8250;</div>
            </div>
            <div class="lightbox-title"></div>
            <hr class="lightbox-rule" />
            <div class="lightbox-description"></div>
        </div>
    </div>
</div>
<script>
(function() {
    // Progressive rendering: show photos in batches as user scrolls
    var BATCH_SIZE = 16;
    var allItems = Array.from(document.querySelectorAll('.photo-gallery-grid .photo-thumb-link'));
    var shown = 0;

    function showBatch() {
        var end = Math.min(shown + BATCH_SIZE, allItems.length);
        for (var i = shown; i < end; i++) {
            allItems[i].classList.add('visible');
        }
        shown = end;
        if (shown >= allItems.length && observer) {
            observer.disconnect();
        }
    }

    // Hide all items initially, then show first batch
    allItems.forEach(function(item) { item.classList.add('gallery-item'); });
    showBatch();

    // IntersectionObserver to load more when sentinel is near viewport
    var sentinel = document.getElementById('scroll-sentinel');
    var observer = null;
    if ('IntersectionObserver' in window && shown < allItems.length) {
        observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting) {
                showBatch();
            }
        }, { rootMargin: '400px' });
        observer.observe(sentinel);
    } else {
        // Fallback: show everything
        allItems.forEach(function(item) { item.classList.add('visible'); });
        shown = allItems.length;
    }

    // Lightbox
    var overlay = document.getElementById('lightbox');
    var img = overlay.querySelector('.lightbox-img');
    var titleEl = overlay.querySelector('.lightbox-title');
    var descEl = overlay.querySelector('.lightbox-description');
    var closeBtn = overlay.querySelector('.lightbox-close');
    var navPrev = overlay.querySelector('.lightbox-nav-prev');
    var navNext = overlay.querySelector('.lightbox-nav-next');
    var ruleEl = overlay.querySelector('.lightbox-rule');
    var headerRuleEl = overlay.querySelector('.lightbox-header-rule');
    var imgAndMeta = overlay.querySelector('.lightbox-img-and-meta');
    var currentIndex = -1;
    var showGen = 0;

    function syncRuleWidths() {
        var w = img.offsetWidth + 'px';
        ruleEl.style.width = w;
        headerRuleEl.style.width = w;
    }

    // Build slug-to-index map for deep linking
    var slugMap = {};
    allItems.forEach(function(link, i) {
        var slug = link.dataset.slug;
        if (slug) slugMap[slug] = i;
    });

    function showPhoto(index) {
        if (index < 0 || index >= allItems.length) return;
        currentIndex = index;
        var gen = ++showGen;
        var link = allItems[index];
        var hadSrc = !!img.getAttribute('src');
        // Reveal if not yet visible (navigated past current batch)
        if (!link.classList.contains('visible')) {
            for (var i = shown; i <= index; i++) {
                allItems[i].classList.add('visible');
            }
            shown = Math.max(shown, index + 1);
        }
        navPrev.style.visibility = index > 0 ? 'visible' : 'hidden';
        navNext.style.visibility = index < allItems.length - 1 ? 'visible' : 'hidden';
        if (link.dataset.slug) {
            history.replaceState(null, '', '#' + link.dataset.slug);
        }

        var preload = new Image();
        preload.onload = function() {
            if (gen !== showGen) return;
            function applyContent() {
                if (gen !== showGen) return;
                img.src = link.href;
                img.alt = link.dataset.alt || '';
                titleEl.textContent = link.dataset.title || '';
                descEl.textContent = link.dataset.description || '';
                titleEl.style.display = link.dataset.title ? '' : 'none';
                descEl.style.display = link.dataset.description ? '' : 'none';
                requestAnimationFrame(function() {
                    if (gen !== showGen) return;
                    syncRuleWidths();
                    imgAndMeta.classList.remove('lightbox-transitioning');
                });
            }
            if (hadSrc) {
                imgAndMeta.classList.add('lightbox-transitioning');
                setTimeout(applyContent, 150);
            } else {
                imgAndMeta.classList.add('lightbox-transitioning');
                applyContent();
            }
        };
        preload.src = link.href;
    }

    function openLightbox(index) {
        showPhoto(index);
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');
    }

    allItems.forEach(function(link, i) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            openLightbox(i);
        });
    });

    function closeLightbox() {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        img.src = '';
        currentIndex = -1;
        history.replaceState(null, '', window.location.pathname);
    }

    // Open from hash on page load
    if (window.location.hash) {
        var slug = window.location.hash.substring(1);
        if (slug in slugMap) {
            openLightbox(slugMap[slug]);
        }
    }

    navPrev.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex > 0) showPhoto(currentIndex - 1);
    });

    navNext.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex < allItems.length - 1) showPhoto(currentIndex + 1);
    });

    closeBtn.addEventListener('click', closeLightbox);
    overlay.addEventListener('click', function(e) {
        if (e.target === img) return;
        if (e.target.closest('.lightbox-nav')) return;
        if (e.target.closest('.lightbox-site-title')) return;
        closeLightbox();
    });
    document.addEventListener('keydown', function(e) {
        if (!overlay.classList.contains('active')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft' && currentIndex > 0) showPhoto(currentIndex - 1);
        if (e.key === 'ArrowRight' && currentIndex < allItems.length - 1) showPhoto(currentIndex + 1);
    });
})();
</script>
{{- end }}
{{- end }}
